<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>[Tech] Adding Light/Dark Theme Support to Graphviz</title>
    <link href="/tech-graphviz_light_dark_support/"/>
    <url>/tech-graphviz_light_dark_support/</url>
    
    <content type="html"><![CDATA[<h2 id="Background"><a href="#Background" class="headerlink" title="Background"></a>Background</h2><p>I‚Äôve been a heavy user of HackMD for a long time. Whether it‚Äôs class notes or self-study materials, basically everything is recorded on HackMD.</p><p>The reason I love HackMD so much is that it combines many convenient features: for example, wrapping text with $$ lets you write $\LaTeX$ mathematical expressions, and using ```graphviz``` lets you create flowcharts (Graphviz). This design where you only need text to generate the required diagrams&#x2F;formulas is incredibly useful.</p><p>When I decided to start building my personal blog, since it also uses markdown format for writing, I didn‚Äôt want to lose these two convenient features. The blog theme I use is based on Fluid‚Äôs <del>modified version</del>, which provides built-in light and dark modes, so I discovered a problem that bothered me.</p><h3 id="The-Problem"><a href="#The-Problem" class="headerlink" title="The Problem"></a>The Problem</h3><p>Let‚Äôs first look at a mathematical expression written with $\LaTeX$ syntax:</p><p>$$<br>\sum\limits_{i&#x3D;0}^{n}a_i<br>$$</p><p>While $\LaTeX$ can adjust font colors based on the background color (try manually switching between light and dark modes!), Graphviz doesn‚Äôt support this. Since native Hexo doesn‚Äôt support rendering Graphviz like HackMD does, I used the <a href="https://github.com/kkppll-ss/hexo-filter-viz"><code>hexo-filter-viz</code></a> package. Let‚Äôs look at an SVG rendered with the original <code>hexo-filter-viz</code>:</p><svg width="337pt" height="184pt" viewBox="0.00 0.00 337.30 183.74" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><g id="graph" class="graph" transform="scale(1 1) rotate(0) translate(4 179.7361)"><title>relax</title><polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-179.7361 333.2956,-179.7361 333.2956,4 -4,4"></polygon><!-- A --><g id="node1" class="node"><title>A</title><ellipse fill="none" stroke="#b2dfee" cx="151.3691" cy="-18.0079" rx="18.0157" ry="18.0157"></ellipse><text text-anchor="middle" x="151.3691" y="-13.8079" font-family="Times,serif" font-size="14.00" fill="#000000">A</text><text text-anchor="middle" x="66.6806" y="-57.0157" font-family="Times,serif" font-size="14.00" fill="#000000">Updated</text><text text-anchor="middle" x="66.6806" y="-40.2157" font-family="Times,serif" font-size="14.00" fill="#000000">Want to go to the cloest</text></g><!-- b --><g id="node2" class="node"><title>b</title><ellipse fill="none" stroke="#ff0000" cx="151.3691" cy="-107.3361" rx="18" ry="18"></ellipse><text text-anchor="middle" x="151.3691" y="-103.1361" font-family="Times,serif" font-size="14.00" fill="#000000">b</text><text text-anchor="middle" x="74.0861" y="-163.1361" font-family="Times,serif" font-size="14.00" fill="#000000">Cloest to</text><text text-anchor="middle" x="74.0861" y="-146.3361" font-family="Times,serif" font-size="14.00" fill="#000000"> the current subgraph</text><text text-anchor="middle" x="74.0861" y="-129.5361" font-family="Times,serif" font-size="14.00" fill="#000000">(Update first)</text></g><!-- A&#45;&gt;b --><g id="edge1" class="edge"><title>A-&gt;b</title><path fill="none" stroke="#ff0000" d="M151.3691,-36.0848C151.3691,-48.4348 151.3691,-65.0488 151.3691,-79.1272"></path><polygon fill="#ff0000" stroke="#ff0000" points="147.8692,-79.2861 151.3691,-89.2861 154.8692,-79.2861 147.8692,-79.2861"></polygon><text text-anchor="middle" x="147.8691" y="-61.806" font-family="Times,serif" font-size="14.00" fill="#000000">1</text></g><!-- c --><g id="node3" class="node"><title>c</title><ellipse fill="none" stroke="#a52a2a" cx="228.7296" cy="-62.672" rx="18" ry="18"></ellipse><text text-anchor="middle" x="228.7296" y="-58.472" font-family="Times,serif" font-size="14.00" fill="#000000">c</text><text text-anchor="middle" x="270.0126" y="-101.672" font-family="Times,serif" font-size="14.00" fill="#000000">Second close to</text><text text-anchor="middle" x="270.0126" y="-84.872" font-family="Times,serif" font-size="14.00" fill="#000000"> the current subgraph</text></g><!-- A&#45;&gt;c --><g id="edge3" class="edge"><title>A-&gt;c</title><path fill="none" stroke="#a52a2a" d="M167.0241,-27.0463C177.7195,-33.2213 192.1078,-41.5284 204.3,-48.5675"></path><polygon fill="#a52a2a" stroke="#a52a2a" points="202.6875,-51.678 213.0978,-53.647 206.1876,-45.6158 202.6875,-51.678"></polygon><text text-anchor="middle" x="182.162" y="-42.0069" font-family="Times,serif" font-size="14.00" fill="#000000">5</text></g><!-- b&#45;&gt;c --><g id="edge2" class="edge"><title>b-&gt;c</title><path fill="none" stroke="#000000" d="M167.0241,-98.2977C177.7195,-92.1227 192.1078,-83.8156 204.3,-76.7765"></path><polygon fill="#000000" stroke="#000000" points="206.1876,-79.7281 213.0978,-71.697 202.6875,-73.666 206.1876,-79.7281"></polygon><text text-anchor="middle" x="182.162" y="-91.7371" font-family="Times,serif" font-size="14.00" fill="#000000">2</text></g></g></svg><br><br><p>The first problem I noticed is <strong>it‚Äôs not centered!</strong> And while it looks fine in light mode, switching to dark mode is painful. That awkward background and lines that don‚Äôt adapt to the theme really need fixingüò¢. After a series of adjustments, I finally achieved the following result:</p><div id="graphviz-0" style="text-align:center;"></div><br><p>Looks fantastic! Except for the parts that originally had colors, everything else now adapts to the light&#x2F;dark theme, and the background is gone! In my markdown files, I just need to use Graphviz as usual to generate theme-supporting flowcharts! Let me introduce what I did!</p><h2 id="Getting-Started"><a href="#Getting-Started" class="headerlink" title="Getting Started"></a>Getting Started</h2><h3 id="How-to-Render"><a href="#How-to-Render" class="headerlink" title="How to Render"></a>How to Render</h3><p>First of all, I want to thank <strong>Chris‚Äôs Tech Notes</strong> for <a href="https://dwatow.github.io/2019/02-04-hexo/hexo-filter-viz/">this article</a>. Actually, the Fluid theme initially didn‚Äôt support generating Graphviz like HackMD does, so I started using his modified package. If you‚Äôre interested, definitely check it out!</p><p>Anyway, after diving into his package, the most important file is <code>lib/render.js</code>:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">var</span> reg = <span class="hljs-regexp">/(\s*)(```) *(graphviz) *\n?([\s\S]+?)\s*(\2)(\n+|$)/g</span>;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">ignore</span>(<span class="hljs-params">data</span>) &#123;<br>  <span class="hljs-keyword">var</span> source = data.<span class="hljs-property">source</span>;<br>  <span class="hljs-keyword">var</span> ext = source.<span class="hljs-title function_">substring</span>(source.<span class="hljs-title function_">lastIndexOf</span>(<span class="hljs-string">&#x27;.&#x27;</span>)).<span class="hljs-title function_">toLowerCase</span>();<br>  <span class="hljs-keyword">return</span> [<span class="hljs-string">&#x27;.js&#x27;</span>, <span class="hljs-string">&#x27;.css&#x27;</span>, <span class="hljs-string">&#x27;.html&#x27;</span>, <span class="hljs-string">&#x27;.htm&#x27;</span>].<span class="hljs-title function_">indexOf</span>(ext) &gt; -<span class="hljs-number">1</span>;<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">getId</span>(<span class="hljs-params">index</span>) &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;graphviz-&#x27;</span> + index;<br>&#125;<br><br><span class="hljs-built_in">exports</span>.<span class="hljs-property">render</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">data</span>) &#123;<br>  <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">ignore</span>(data)) &#123;<br><br>    <span class="hljs-keyword">var</span> graphviz = [];<br><br>    data.<span class="hljs-property">content</span> = data.<span class="hljs-property">content</span><br>      .<span class="hljs-title function_">replace</span>(reg, <span class="hljs-keyword">function</span>(<span class="hljs-params">raw, start, startQuote, lang, content, endQuote, end</span>) &#123;<br>        <span class="hljs-keyword">var</span> graphvizId = <span class="hljs-title function_">getId</span>(graphviz.<span class="hljs-property">length</span>);<br>        graphviz.<span class="hljs-title function_">push</span>(content);<br>        <span class="hljs-keyword">return</span> start + <span class="hljs-string">&#x27;&lt;div id=&quot;&#x27;</span> + graphvizId + <span class="hljs-string">&#x27;&gt;&lt;/div&gt;&#x27;</span> + end;<br>      &#125;);<br><br>    <span class="hljs-keyword">if</span> (graphviz.<span class="hljs-property">length</span>) &#123;<br>      <span class="hljs-keyword">var</span> config = <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>.<span class="hljs-property">graphviz</span>;<br>      <span class="hljs-comment">// resources</span><br>      data.<span class="hljs-property">content</span> += <span class="hljs-string">&#x27;&lt;script src=&quot;&#x27;</span> + config.<span class="hljs-property">vizjs</span> + <span class="hljs-string">&#x27;&quot;&gt;&lt;/script&gt;&#x27;</span>;<br>      data.<span class="hljs-property">content</span> += <span class="hljs-string">&#x27;&lt;script src=&quot;&#x27;</span> + config.<span class="hljs-property">render</span> + <span class="hljs-string">&#x27;&quot;&gt;&lt;/script&gt;&#x27;</span>;<br>      data.<span class="hljs-property">content</span> += graphviz.<span class="hljs-title function_">map</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">code, index</span>) &#123;<br>        <span class="hljs-keyword">var</span> graphvizId = <span class="hljs-title function_">getId</span>(index);<br>        <span class="hljs-keyword">var</span> codeId = graphvizId + <span class="hljs-string">&#x27;-code&#x27;</span>;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;&#x27;</span> +<br>          <span class="hljs-string">&#x27;&#123;% raw %&#125;&#x27;</span> +<br>          <span class="hljs-string">&#x27;&lt;textarea id=&quot;&#x27;</span> + codeId + <span class="hljs-string">&#x27;&quot; style=&quot;display: none&quot;&gt;&#x27;</span> + code + <span class="hljs-string">&#x27;&lt;/textarea&gt;&#x27;</span> +<br>          <span class="hljs-string">&#x27;&lt;script&gt;&#x27;</span> +<br>          <span class="hljs-string">&#x27;  var viz = new Viz();&#x27;</span> +<br>          <span class="hljs-string">&#x27;  var code = document.getElementById(&quot;&#x27;</span> + codeId + <span class="hljs-string">&#x27;&quot;).value;&#x27;</span> +<br>          <span class="hljs-string">&#x27;  viz.renderSVGElement(code)&#x27;</span> +<br>          <span class="hljs-string">&#x27;  .then(function(element) &#123;&#x27;</span> +<br>          <span class="hljs-string">&#x27;    document.getElementById(&quot;&#x27;</span> + graphvizId + <span class="hljs-string">&#x27;&quot;).append(element);&#x27;</span> +<br>          <span class="hljs-string">&#x27;  &#125;);&#x27;</span> +<br>          <span class="hljs-string">&#x27;&lt;/script&gt;&#x27;</span> +<br>          <span class="hljs-string">&#x27;&#123;% endraw %&#125;&#x27;</span>;<br>      &#125;).<span class="hljs-title function_">join</span>(<span class="hljs-string">&#x27;&#x27;</span>);<br>    &#125;<br>  &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><p>I see! So basically it parses the original code block, then uses <code>&#123;%„ÄÄraw„ÄÄ%&#125;</code> to inject code, and uses <code>Viz</code> to render the entire code. Finally, it returns the rendered element to the <code>&lt;div id=&quot;graphvizID&quot;&gt;&lt;/div&gt;</code>. Got it, understood the general idea.</p><p>Looks like this is where I need to make modifications. What are we waiting for? Let‚Äôs fork it and start coding!</p><h3 id="Centering"><a href="#Centering" class="headerlink" title="Centering"></a>Centering</h3><p>Actually, the first thing that bothered me was <strong>the default result isn‚Äôt centered</strong>, which was painful to look at. So let me manually add the <code>style=&quot;text-align:center;&quot;</code> attribute to the <code>&lt;div id=&quot;graphvizID&quot;&gt;&lt;/div&gt;</code> tag!</p><h3 id="Removing-Background-and-Modifying-Line-Colors"><a href="#Removing-Background-and-Modifying-Line-Colors" class="headerlink" title="Removing Background and Modifying Line Colors"></a>Removing Background and Modifying Line Colors</h3><p>Next is the background color. Although I could manually write <code>bgcolor=transparent;</code> when writing markdown, I found that inelegant, so I decided to directly modify the code injected into <code>&#123;%„ÄÄraw„ÄÄ%&#125;</code>. First, let‚Äôs look at the structure of the rendered SVG:</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">svg</span> <span class="hljs-attr">width</span>=<span class="hljs-string">&quot;337pt&quot;</span> <span class="hljs-attr">height</span>=<span class="hljs-string">&quot;184pt&quot;</span> <span class="hljs-attr">viewBox</span>=<span class="hljs-string">&quot;0.00 0.00 337.30 183.74&quot;</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://www.w3.org/2000/svg&quot;</span> <span class="hljs-attr">xmlns:xlink</span>=<span class="hljs-string">&quot;http://www.w3.org/1999/xlink&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">g</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;graph0&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;graph&quot;</span> <span class="hljs-attr">transform</span>=<span class="hljs-string">&quot;scale(1 1) rotate(0) translate(4 179.7361)&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>relax<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">polygon</span> <span class="hljs-attr">fill</span>=<span class="hljs-string">&quot;#ffffff&quot;</span> <span class="hljs-attr">stroke</span>=<span class="hljs-string">&quot;transparent&quot;</span> <span class="hljs-attr">points</span>=<span class="hljs-string">&quot;-4,4 -4,-179.7361 333.2956,-179.7361 333.2956,4 -4,4&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">polygon</span>&gt;</span><br><span class="hljs-comment">&lt;!-- A --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">g</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;node1&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;node&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>A<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">ellipse</span> <span class="hljs-attr">fill</span>=<span class="hljs-string">&quot;none&quot;</span> <span class="hljs-attr">stroke</span>=<span class="hljs-string">&quot;#b2dfee&quot;</span> <span class="hljs-attr">cx</span>=<span class="hljs-string">&quot;151.3691&quot;</span> <span class="hljs-attr">cy</span>=<span class="hljs-string">&quot;-18.0079&quot;</span> <span class="hljs-attr">rx</span>=<span class="hljs-string">&quot;18.0157&quot;</span> <span class="hljs-attr">ry</span>=<span class="hljs-string">&quot;18.0157&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">ellipse</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">text</span> <span class="hljs-attr">text-anchor</span>=<span class="hljs-string">&quot;middle&quot;</span> <span class="hljs-attr">x</span>=<span class="hljs-string">&quot;151.3691&quot;</span> <span class="hljs-attr">y</span>=<span class="hljs-string">&quot;-13.8079&quot;</span> <span class="hljs-attr">font-family</span>=<span class="hljs-string">&quot;Times,serif&quot;</span> <span class="hljs-attr">font-size</span>=<span class="hljs-string">&quot;14.00&quot;</span> <span class="hljs-attr">fill</span>=<span class="hljs-string">&quot;#000000&quot;</span>&gt;</span>A<span class="hljs-tag">&lt;/<span class="hljs-name">text</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">text</span> <span class="hljs-attr">text-anchor</span>=<span class="hljs-string">&quot;middle&quot;</span> <span class="hljs-attr">x</span>=<span class="hljs-string">&quot;66.6806&quot;</span> <span class="hljs-attr">y</span>=<span class="hljs-string">&quot;-57.0157&quot;</span> <span class="hljs-attr">font-family</span>=<span class="hljs-string">&quot;Times,serif&quot;</span> <span class="hljs-attr">font-size</span>=<span class="hljs-string">&quot;14.00&quot;</span> <span class="hljs-attr">fill</span>=<span class="hljs-string">&quot;#000000&quot;</span>&gt;</span>Updated<span class="hljs-tag">&lt;/<span class="hljs-name">text</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">text</span> <span class="hljs-attr">text-anchor</span>=<span class="hljs-string">&quot;middle&quot;</span> <span class="hljs-attr">x</span>=<span class="hljs-string">&quot;66.6806&quot;</span> <span class="hljs-attr">y</span>=<span class="hljs-string">&quot;-40.2157&quot;</span> <span class="hljs-attr">font-family</span>=<span class="hljs-string">&quot;Times,serif&quot;</span> <span class="hljs-attr">font-size</span>=<span class="hljs-string">&quot;14.00&quot;</span> <span class="hljs-attr">fill</span>=<span class="hljs-string">&quot;#000000&quot;</span>&gt;</span>Want to go to the cloest<span class="hljs-tag">&lt;/<span class="hljs-name">text</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">g</span>&gt;</span><br><span class="hljs-comment">&lt;!-- A&amp;#45;&amp;gt;c --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">g</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;edge3&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;edge&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>A-<span class="hljs-symbol">&amp;gt;</span>c<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">path</span> <span class="hljs-attr">fill</span>=<span class="hljs-string">&quot;none&quot;</span> <span class="hljs-attr">stroke</span>=<span class="hljs-string">&quot;#a52a2a&quot;</span> <span class="hljs-attr">d</span>=<span class="hljs-string">&quot;M167.0241,-27.0463C177.7195,-33.2213 192.1078,-41.5284 204.3,-48.5675&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">path</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">polygon</span> <span class="hljs-attr">fill</span>=<span class="hljs-string">&quot;#a52a2a&quot;</span> <span class="hljs-attr">stroke</span>=<span class="hljs-string">&quot;#a52a2a&quot;</span> <span class="hljs-attr">points</span>=<span class="hljs-string">&quot;202.6875,-51.678 213.0978,-53.647 206.1876,-45.6158 202.6875,-51.678&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">polygon</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">text</span> <span class="hljs-attr">text-anchor</span>=<span class="hljs-string">&quot;middle&quot;</span> <span class="hljs-attr">x</span>=<span class="hljs-string">&quot;182.162&quot;</span> <span class="hljs-attr">y</span>=<span class="hljs-string">&quot;-42.0069&quot;</span> <span class="hljs-attr">font-family</span>=<span class="hljs-string">&quot;Times,serif&quot;</span> <span class="hljs-attr">font-size</span>=<span class="hljs-string">&quot;14.00&quot;</span> <span class="hljs-attr">fill</span>=<span class="hljs-string">&quot;#000000&quot;</span>&gt;</span>5<span class="hljs-tag">&lt;/<span class="hljs-name">text</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">g</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">g</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">svg</span>&gt;</span><br></code></pre></td></tr></table></figure><p>Although I‚Äôve only listed a few important components here, from the rendered result we can see: the outermost <code>svg</code> tag adjusts the overall SVG image size, and going to the first level <code>g</code> represents the entire graph, where the first <code>polygon</code> inside is the background, and the following <code>g</code> elements represent graph components like <code>node</code> for shapes and <code>edge</code> for arrows, which contain smaller elements to form the required shapes.</p><p>My approach here is to adjust colors by modifying <code>fill</code> and <code>stroke</code>: if I want something invisible, set the color to <code>transparent</code>, and if I want it to adapt to the theme‚Äôs text color, change it to <code>var(--text-color)</code>. So here I handle the background and other polygons together:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">var</span> viz = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Viz</span>();<br><span class="hljs-keyword">var</span> code = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&quot; + codeId + &quot;</span>).<span class="hljs-property">value</span>;<br>viz.<span class="hljs-title function_">renderSVGElement</span>(code)<br>.<span class="hljs-title function_">then</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">element</span>) &#123;<br>element.<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">&quot;width&quot;</span>, <span class="hljs-string">&quot;100%&quot;</span>); <span class="hljs-comment">// Adjust size</span><br>polygons = element.<span class="hljs-title function_">getElementsByTagName</span>(<span class="hljs-string">&quot;polygon&quot;</span>);<br><span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; polygons.<span class="hljs-property">length</span>; i += <span class="hljs-number">1</span>) &#123;<br>    <span class="hljs-keyword">if</span> (polygons[i].<span class="hljs-property">parentElement</span>.<span class="hljs-property">className</span>.<span class="hljs-property">baseVal</span> == <span class="hljs-string">&quot;graph&quot;</span>) &#123;<br>        polygons[i].<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">&quot;stroke&quot;</span>, <span class="hljs-string">&quot;transparent&quot;</span>); <span class="hljs-comment">// Background</span><br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (polygons[i].<span class="hljs-title function_">getAttribute</span>(<span class="hljs-string">&quot;stroke&quot;</span>) == <span class="hljs-string">&quot;#000000&quot;</span>) &#123;<br>        polygons[i].<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">&quot;stroke&quot;</span>, <span class="hljs-string">&quot;var(--text-color)&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (polygons[i].<span class="hljs-property">parentElement</span>.<span class="hljs-property">className</span>.<span class="hljs-property">baseVal</span> == <span class="hljs-string">&quot;graph&quot;</span>) &#123;<br>        polygons[i].<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">&quot;fill&quot;</span>, <span class="hljs-string">&quot;transparent&quot;</span>);  <span class="hljs-comment">// Background</span><br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (polygons[i].<span class="hljs-title function_">getAttribute</span>(<span class="hljs-string">&quot;fill&quot;</span>) == <span class="hljs-string">&quot;#000000&quot;</span> &amp;&amp; polygons[i].<span class="hljs-property">parentElement</span>.<span class="hljs-property">className</span>.<span class="hljs-property">baseVal</span> == <span class="hljs-string">&quot;edge&quot;</span>) &#123;<br>        polygons[i].<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">&quot;fill&quot;</span>, <span class="hljs-string">&quot;var(--text-color)&quot;</span>);<br>    &#125;<br>&#125;<br>paths = element.<span class="hljs-title function_">getElementsByTagName</span>(<span class="hljs-string">&quot;path&quot;</span>);<br><span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; paths.<span class="hljs-property">length</span>; i += <span class="hljs-number">1</span>) &#123;<br>    <span class="hljs-keyword">if</span> (paths[i].<span class="hljs-title function_">getAttribute</span>(<span class="hljs-string">&quot;fill&quot;</span>) == <span class="hljs-string">&quot;none&quot;</span> &amp;&amp; paths[i].<span class="hljs-property">parentElement</span>.<span class="hljs-property">className</span>.<span class="hljs-property">baseVal</span> == <span class="hljs-string">&quot;edge&quot;</span>) &#123; <br>        paths[i].<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">&quot;fill&quot;</span>, <span class="hljs-string">&quot;var(--text-color)&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (paths[i].<span class="hljs-title function_">getAttribute</span>(<span class="hljs-string">&quot;stroke&quot;</span>) == <span class="hljs-string">&quot;#000000&quot;</span> &amp;&amp; paths[i].<span class="hljs-property">parentElement</span>.<span class="hljs-property">className</span>.<span class="hljs-property">baseVal</span> == <span class="hljs-string">&quot;edge&quot;</span>) &#123; <br>        paths[i].<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">&quot;stroke&quot;</span>, <span class="hljs-string">&quot;var(--text-color)&quot;</span>);<br>    &#125;<br>&#125;<br>ellipses = element.<span class="hljs-title function_">getElementsByTagName</span>(<span class="hljs-string">&quot;ellipse&quot;</span>);<br><span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; ellipses.<span class="hljs-property">length</span>; i += <span class="hljs-number">1</span>) &#123;<br>    <span class="hljs-keyword">if</span> (ellipses[i].<span class="hljs-title function_">getAttribute</span>(<span class="hljs-string">&quot;stroke&quot;</span>) == <span class="hljs-string">&quot;#000000&quot;</span>) &#123; <br>        ellipses[i].<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">&quot;stroke&quot;</span>, <span class="hljs-string">&quot;var(--text-color)&quot;</span>);<br>    &#125;<br>&#125;<br>texts = element.<span class="hljs-title function_">getElementsByTagName</span>(<span class="hljs-string">&quot;text&quot;</span>); <br><span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; texts.<span class="hljs-property">length</span>; i += <span class="hljs-number">1</span>) &#123;<br>    <span class="hljs-keyword">if</span> (texts[i].<span class="hljs-title function_">getAttribute</span>(<span class="hljs-string">&quot;fill&quot;</span>) == <span class="hljs-string">&quot;#000000&quot;</span>) &#123; <br>        texts[i].<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">&quot;fill&quot;</span>, <span class="hljs-string">&quot;var(--text-color)&quot;</span>);<br>    &#125;<br>    texts[i].<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">&quot;stroke&quot;</span>, <span class="hljs-string">&quot;none&quot;</span>);<br>&#125;<br><span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&quot; + graphvizId + &quot;</span>).<span class="hljs-title function_">append</span>(element);<br>&#125;);<br></code></pre></td></tr></table></figure><blockquote><p>Here I‚Äôve only adjusted the elements I think are commonly used. I haven‚Äôt included others that I think are rarely used.</p></blockquote><p>This just shows the key JavaScript code to be injected into <code>&#123;%„ÄÄraw„ÄÄ%&#125;</code>. You can see it simply changes fill and stroke default values to the theme-adapted <code>var(--text-color)</code>, and in Polygon, there‚Äôs an additional check for background cases.</p><h3 id="Adjusting-Size"><a href="#Adjusting-Size" class="headerlink" title="Adjusting Size"></a>Adjusting Size</h3><p>Finally, after making adjustments, I found that if the given diagram is too large, it actually exceeds the note‚Äôs layout (overflows to the right), so on line 5 I manually adjusted the width to 100%, so it won‚Äôt overflow!</p><h3 id="Final-Product"><a href="#Final-Product" class="headerlink" title="Final Product"></a>Final Product</h3><p>Okay! After the above adjustments, everything looks good after a quick review! So I saved the modified result in <a href="https://github.com/torrid-fish/hexo-filter-viz-customized"><code>hexo-filter-viz-customized</code></a>, so my CI&#x2F;CD on GitHub can also download this package and properly render Graphviz for me! Awesome!</p><h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>Actually, I wanted to make this modification around summer 2023, but I was too busy and kept postponing it until winter break, when I fixed this small issue on a whim. Before completing Software Design Lab in my sophomore year, I was still quite intimidated by JavaScript in web pages, but I think through this implementation, I‚Äôve also discovered my ability to read documentation and implement the features I need. I think this is also a kind of growth XD. Although what I made is simple, it still significantly improves the overall aesthetics. Looking forward to continuing to enhance this blog furtherüòé.<script src="https://unpkg.com/viz.js@2.1.2/viz.js"></script><script src="https://unpkg.com/viz.js@2.1.2/full.render.js"></script><textarea id="graphviz-0-code" style="display: none">digraph relax{    layout = circo;    node [shape = circle];    A -> b [color = "red", label = "1"];    b -> c [label = "2"];    A -> c [color = "brown", label = "5"];    A [color = "lightblue2", xlabel = "Updated\nWant to go to the cloest"];    b [color = "red", xlabel = "Cloest to\n the current subgraph\n(Update first)"];    c [color = "brown", xlabel = "Second close to\n the current subgraph"];}</textarea><script>  var viz = new Viz();  var code = document.getElementById("graphviz-0-code").value;  viz.renderSVGElement(code)  .then(function(element) {    element.setAttribute("width", "100%");     polygons = element.getElementsByTagName("polygon");    for (var i = 0; i < polygons.length; i += 1) {        if (polygons[i].parentElement.className.baseVal == "graph") {            polygons[i].setAttribute("stroke", "transparent");        } else if (polygons[i].getAttribute("stroke") == "#000000") {            polygons[i].setAttribute("stroke", "var(--text-color)");        }        if (polygons[i].parentElement.className.baseVal == "graph") {            polygons[i].setAttribute("fill", "transparent");        } else if (polygons[i].getAttribute("fill") == "#000000" && polygons[i].parentElement.className.baseVal == "edge") {            polygons[i].setAttribute("fill", "var(--text-color)");        }    }    paths = element.getElementsByTagName("path");    for (var i = 0; i < paths.length; i += 1) {        if (paths[i].getAttribute("fill") == "none" && paths[i].parentElement.className.baseVal == "edge") {             paths[i].setAttribute("fill", "var(--text-color)");        }        if (paths[i].getAttribute("stroke") == "#000000" && paths[i].parentElement.className.baseVal == "edge") {             paths[i].setAttribute("stroke", "var(--text-color)");        }    }    ellipses = element.getElementsByTagName("ellipse");    for (var i = 0; i < ellipses.length; i += 1) {        if (ellipses[i].getAttribute("stroke") == "#000000") {             ellipses[i].setAttribute("stroke", "var(--text-color)");        }    }    texts = element.getElementsByTagName("text");    for (var i = 0; i < texts.length; i += 1) {        if (texts[i].getAttribute("fill") == "#000000") {             texts[i].setAttribute("fill", "var(--text-color)");        }        texts[i].setAttribute("stroke", "none");    }    document.getElementById("graphviz-0").append(element);  });</script></p>]]></content>
    
    
    <categories>
      
      <category>Technology</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Torrid-Blog Development</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>[Life] 2024 TSMC IT CareerHack Campus Hackathon</title>
    <link href="/life-tsmc_2024_hackthon/"/>
    <url>/life-tsmc_2024_hackthon/</url>
    
    <content type="html"><![CDATA[<h3 id="Participation"><a href="#Participation" class="headerlink" title="Participation"></a>Participation</h3><p>I was invited by Chen-Zhong to participate in <a href="https://www.tsmc.com/static/english/careers/2024Careerhack/index.html">TSMC‚Äôs 2024 Campus Hackathon</a>. Riding on the momentum from our good results at the Mei-Chu Hackathon, I wanted to see if we could win a second award, so I signed up for this competition.</p><p>When we were looking at the themes, since He-Kun and I had already read many papers and implementations related to CV (Computer Vision) in our reading group, we decided to choose the ‚ÄúAI Image Storytelling‚Äù theme.</p><h3 id="Preliminary-Round"><a href="#Preliminary-Round" class="headerlink" title="Preliminary Round"></a>Preliminary Round</h3><p>To actually compete in the finals at their Taipei office on 1&#x2F;26 and 1&#x2F;27, we had to participate in the online preliminary round. Basically, it was testing programming ability, with languages like C++, Python, Java to choose from. The problems were relatively simple - mine were just greedy algorithms and some very basic problems. I heard from friends that there were also tree-related problems. But it was really quite basic, <del>reminds me of the freshman programming late-night sessions</del>.</p><p>Anyway, I personally feel the preliminaries and finals had little connection. I found it quite surprising they used this mechanism for screening. (I heard there were over 100 teams registered, and they eventually selected 24 teams)</p><h3 id="Finals"><a href="#Finals" class="headerlink" title="Finals"></a>Finals</h3><p>After that, we were notified we made it to the finals, along with information about the problem and hackathon schedule. We started preparing.</p><h4 id="Problem-AI-Image-Storytelling"><a href="#Problem-AI-Image-Storytelling" class="headerlink" title="Problem: AI Image Storytelling"></a>Problem: AI Image Storytelling</h4><p>The organizers provided a dataset containing images with safety helmets and GPT conversation results, plus a LLaVA model pretrained with LoRA. Our task was to use this information to create a system that could process images and answer these questions:</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br><span class="hljs-attr">&quot;Q1&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Is there any people not wearing a helmets? Please answer with true or false.&quot;</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;Q2&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;How many people are there in the image? Please give a single integer answer.&quot;</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;Q3&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;How many people are there and wear a helmets in the image? Please give a single integer answer.&quot;</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;Q4&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;How many people are there and not wear a helmets in the image? Please give a single integer answer.&quot;</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;Q5&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Tell the color of the helmets that people wear in the image from this list: red, yellow, blue, white, green, orange, black.The answer may be more than one color.If there is no one wear a helmets, please answer None as response. &quot;</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;Q6&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;What is the warning message shown in the image? Just give me the warning sentence.&quot;</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;Q7&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Is there anyone violating the warning message describe in the image?  Please answer with true or false.&quot;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p>Finally, scoring would be done using a private test set provided by the organizers. 70% of the final score would be based on the correctness of the above outputs. Only 30% would be determined by the on-site demo performance.</p><p>This scoring mechanism was completely different from the Mei-Chu Hackathon I participated in before, and there were some issues I found quite puzzling:<br>The private set only had 107 images, and they gave us nearly 1.5 hours to generate results. If someone wanted to, manually annotating all the answers wouldn‚Äôt be impossible. How could they ensure no team manually filled in all the answers? Although people were monitoring and warning us not to cheat, I still found it somewhat unreasonable.</p><h4 id="Problems-Encountered-on-GCP-Google-Cloud-Platform"><a href="#Problems-Encountered-on-GCP-Google-Cloud-Platform" class="headerlink" title="Problems Encountered on GCP (Google Cloud Platform)"></a>Problems Encountered on GCP (Google Cloud Platform)</h4><p>This time they also had Google Cloud provide computing resources for us to use, but our experience using it wasn‚Äôt very smooth.</p><p>When we tried to finetune instruct-BLIP, we once crashed the RAM, causing the entire instance to break. Before the competition, our instance also broke for unknown reasons, and we received an email asking if we did something to break it, but we had no idea what happened - we didn‚Äôt do any special operations.</p><p>For example, the instance they provided broke twice:</p><ul><li>The first time was 2 days after the hackathon when I suddenly received an email from the organizers reminding us that our instance crashed, asking if we ran any commands. But we didn‚Äôt do any special operations, so we still don‚Äôt understand what happened to the machine.</li><li>The second time was the day before the competition when we tried to load instruct-BLIP into the instance to finetune, apparently filling up the disk, and the entire instance crashed.</li></ul><p>Similarly, besides the instance, there were also problems with the bucket they provided:<br>Before and during the competition, both He-Kun and I encountered permission errors when trying to upload large files from the instance to the bucket. It wasn‚Äôt until the Google Cloud team came to provide support that day that they discovered the problem was because it would request an additional ‚Äúget‚Äù command from the bucket, and our instance initially didn‚Äôt seem to have this permission, causing this issue.</p><p>However, I must mention that the staff were really very proactive. Basically, they addressed problems immediately. When fixing the bucket issue, I really felt their enthusiasm, which also caused me considerable pressure (the pressure of having 6-7 people surrounding you is no joke‚Ä¶). Anyway, I‚Äôm really grateful for their help!</p><h4 id="Results"><a href="#Results" class="headerlink" title="Results"></a>Results</h4><p>Although we encountered many situations during the competition: like my long-lasting gastroenteritis, getting rejected for Google‚Äôs internship application, plus losing one team member on the second day (he went to Japanüò¢), which more or less affected our performance these two days, so what we accomplished was far below my expectations. But I think the more important reason we didn‚Äôt perform well was actually ‚Äúwe started too late‚Äù and ‚Äúmisunderstood the problem.‚Äù</p><h5 id="Started-Too-Late"><a href="#Started-Too-Late" class="headerlink" title="Started Too Late"></a>Started Too Late</h5><p>After the workshop ended, we basically only did simple paper reviews and tested three architectures: LLaVA, BLIP, and Flamingo. We discovered very late that the resources the organizers provided weren‚Äôt enough for BLIP and Flamingo to use, so a lot of time was spent on things that didn‚Äôt contribute much to the final result. Additionally, because of my health during those days, I only did simple data analysis and didn‚Äôt at least run through their sample code to finetune LLaVA - this wasn‚Äôt done until competition day, so I think we really started working too late. With the two days of competition, what we could produce was probably just this much.</p><h5 id="Misunderstood-the-Problem"><a href="#Misunderstood-the-Problem" class="headerlink" title="Misunderstood the Problem"></a>Misunderstood the Problem</h5><p>When we first saw the problem, we thought ‚Äúdo the first few questions really need generative models?‚Äù The required questions could actually be solved well with CV models we learned, so why would we need generative models (of course for questions like Q7 that ask about logic, we also thought they were necessary)? So we wrote to the organizers asking if we could use computer vision models to answer, but their response was ‚Äúwe don‚Äôt recommend using specialized models to answer one by one, because questions like #7 require more general capabilities.‚Äù Although we felt they didn‚Äôt answer our question, we understood it as they ‚Äúdidn‚Äôt want‚Äù us to use non-generative models. Then on competition day, we saw many teams combining CV model outputs with questions into new prompts for LLMs to generate results. Besides admiring other teams‚Äô creativity, we also regretted misunderstanding the organizers‚Äô intention and not thinking in the direction of combining image recognition with LLMs. This was the most regrettable part of this competition.</p><h3 id="Reflections"><a href="#Reflections" class="headerlink" title="Reflections"></a>Reflections</h3><p>This competition felt regrettable because we didn‚Äôt give our full effort. Although we received praise from judges: ‚ÄúWhat a pity! You were on the border (4th place)! And you‚Äôre only juniors, so young, the other teams are all graduate students!‚Äù - and I think it was probably consolation, but hearing it still made me feel better, which is magical. However, this experience was perfect for me to explore the entire LLM architecture and have the opportunity to actually use deepspeed to finetune a model, which perfectly aligned with the tasks my lab professor would give me later. So I‚Äôve now changed my mindset and think that having these gains from this competition is already quite sufficient. The rest is left for my future self to work on. I hope my future self looking back at participating in this competition will feel that I‚Äôve grown a lot!</p>]]></content>
    
    
    <categories>
      
      <category>Life</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Hackathon</tag>
      
      <tag>Competition</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
